---
phase: 12-cli-toolchain
plan: 02
subsystem: cli
tags: [typer, rich, pydantic, yaml, codegen, validate, generate]

requires:
  - phase: 01-dsl-core
    provides: StateMachineDefinition, load_yaml, parse_definition, load_definition, validate_definition
  - phase: 02-code-generation
    provides: generator.generate() producing orchestrator.py and handler stubs with Generation Gap
  - phase: 12-01
    provides: Typer app, app.command() registration pattern, CliRunner test pattern

provides:
  - rsf validate subcommand: loads YAML, Pydantic validation, semantic validation, field-path error reporting
  - rsf generate subcommand: validate then codegen, Rich summary with created/skipped handler counts
  - 16 passing CLI tests (8 validate + 8 generate) using typer.testing.CliRunner

affects: [12-03, 12-04]

tech-stack:
  added: []
  patterns:
    - "validate_cmd and generate_cmd share identical YAML-load → Pydantic → semantic validation pipeline"
    - "Field-path errors from Pydantic: '.'.join(str(loc) for loc in err['loc'])"
    - "Field-path errors from semantic ValidationError: error.path attribute"
    - "Generation Gap preserved: handler stubs without GENERATED_MARKER are never overwritten"
    - "Rich console for all output: [green]Valid:[/green], [red]Error:[/red], [yellow]Skipped:[/yellow]"

key-files:
  created:
    - src/rsf/cli/validate_cmd.py
    - src/rsf/cli/generate_cmd.py
    - tests/test_cli/test_validate.py
    - tests/test_cli/test_generate.py
  modified:
    - src/rsf/cli/main.py

key-decisions:
  - "validate_cmd and generate_cmd share the same 3-stage validation pipeline (YAML parse → Pydantic → semantic) — no shared helper to keep each command self-contained and readable"
  - "generate_cmd passes handlers_dir=output_dir/'handlers' explicitly to generator.generate() to keep output structure predictable and testable"
  - "Both commands print field-path errors for Pydantic via err['loc'] join and for semantic via ValidationError.path attribute"

patterns-established:
  - "CLI validation pipeline: load_yaml → parse_definition (catches Pydantic ValidationError) → validate_definition (catches semantic errors) — both exit 1 with field-path messages"
  - "rsf generate Rich summary: green checkmarks for created files, yellow for skipped, final handler count line"

requirements-completed: [CLI-02, CLI-03]

duration: 2min
completed: 2026-02-26
---

# Phase 12 Plan 02: rsf validate and rsf generate Subcommands Summary

**rsf validate with field-path Pydantic + semantic error reporting, and rsf generate wiring DSL parser + validator + codegen with Generation Gap preservation**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-26T14:38:56Z
- **Completed:** 2026-02-26T14:41:20Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- `rsf validate workflow.yaml`: checks YAML parse → Pydantic structural → semantic cross-state references; prints field-path-specific errors on failure with exit code 1, `Valid: <path>` on success with exit code 0
- `rsf generate workflow.yaml`: runs the same 3-stage validation pipeline, then calls `codegen.generator.generate()`, prints Rich summary with green (created) / yellow (skipped) handler lines and handler count
- Generation Gap preserved: existing handler stubs without the `# DO NOT EDIT - Generated by RSF` marker are skipped, not overwritten
- 16 total tests passing: 8 for validate (valid, not-found, malformed YAML, missing field, dangling Next, no-file-creation, valid fixture, semantic fixture) and 8 for generate (creation, generation gap, invalid input, semantic error, not-found, default arg, multi-task, summary output)

## Task Commits

Each task was committed atomically:

1. **Task 1: rsf validate subcommand with field-path error reporting** - `8093cca` (feat)
2. **Task 2: rsf generate subcommand with orchestrator and handler output** - `224bded` (feat)

**Plan metadata:** (docs: complete plan — this commit)

## Files Created/Modified
- `src/rsf/cli/validate_cmd.py` - validate subcommand: YAML load, Pydantic validation, semantic validation, Rich output
- `src/rsf/cli/generate_cmd.py` - generate subcommand: same validation pipeline + codegen.generator.generate(), Rich summary
- `src/rsf/cli/main.py` - Added validate and generate subcommand registrations
- `tests/test_cli/test_validate.py` - 8 tests for rsf validate
- `tests/test_cli/test_generate.py` - 8 tests for rsf generate

## Decisions Made
- Both validate_cmd and generate_cmd implement the full validation pipeline inline (no shared helper) to keep each command self-contained and easy to read.
- `generate_cmd` explicitly passes `handlers_dir=output_dir / "handlers"` to `codegen.generator.generate()` for predictable, testable output structure.
- Field-path error formatting uses `".".join(str(loc) for loc in err["loc"])` for Pydantic errors and `error.path` for semantic `ValidationError` objects.

## Deviations from Plan

None - plan executed exactly as written. Both commands implemented per spec with the described signatures, behavior, and test coverage.

## Issues Encountered
None. All tests passed on first run.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- `rsf validate` and `rsf generate` are complete and tested
- Plans 12-03 and 12-04 can add remaining subcommands (run, deploy, import, ui, inspect) following the same `app.command(name=...)(mod.func)` pattern in main.py

---
*Phase: 12-cli-toolchain*
*Completed: 2026-02-26*
