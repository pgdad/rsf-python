---
phase: 35-run-all-tests-that-do-not-require-aws-access-resources
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/approval-workflow/tests/conftest.py
  - examples/data-pipeline/tests/conftest.py
  - examples/intrinsic-showcase/tests/conftest.py
  - examples/order-processing/tests/conftest.py
  - examples/retry-and-recovery/tests/conftest.py
  - pyproject.toml
  - .github/workflows/ci.yml
autonomous: true
requirements: []

must_haves:
  truths:
    - "A single pytest invocation runs all 592 unit tests from tests/ AND all 152 example local tests from examples/*/tests/"
    - "pytest -m 'not integration' from the project root runs all non-AWS tests with zero failures"
    - "CI runs all non-AWS tests (both tests/ and examples/) and fails the build on any test failure"
    - "The 13 integration-marked tests are excluded from the default test run"
  artifacts:
    - path: "pyproject.toml"
      provides: "Updated pytest config with testpaths including examples and importmode=importlib"
      contains: "importmode"
    - path: ".github/workflows/ci.yml"
      provides: "CI test step running all non-AWS tests"
      contains: "not integration"
  key_links:
    - from: "pyproject.toml"
      to: "examples/*/tests/test_local.py"
      via: "testpaths configuration"
      pattern: "testpaths.*examples"
    - from: ".github/workflows/ci.yml"
      to: "pyproject.toml"
      via: "pytest reads config from pyproject.toml"
      pattern: "pytest -m"
---

<objective>
Fix the module naming collision that prevents running all example local tests together, configure pytest to discover both tests/ and examples/*/tests/ in a single invocation, and update CI to run the full non-AWS test suite.

Purpose: Currently 152 example local tests exist but are not run in CI or discoverable from the project root. This phase ensures ALL non-AWS tests are run, catching regressions in both the core library and the example workflows.

Output: A single `pytest -m "not integration"` command from the project root runs all 744 non-AWS tests (592 unit + 152 example local) with zero failures, and CI does the same.
</objective>

<execution_context>
@/home/esa/.claude/get-shit-done/workflows/execute-plan.md
@/home/esa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@pyproject.toml
@.github/workflows/ci.yml
@examples/order-processing/tests/conftest.py
@examples/approval-workflow/tests/conftest.py

Current state:
- 592 unit tests in tests/ pass with `pytest -m "not integration"`
- 152 local tests across 5 examples/*/tests/test_local.py pass when run individually
- Running `pytest examples/` fails with `ImportPathMismatchError` because all 5 example test directories have identically-named `tests/conftest.py` files and pytest's default import mode (`prepend`) caches the first module and collides on the rest
- CI only runs tests from tests/ directory, missing all 152 example local tests

The root cause is pytest's default `importmode = "prepend"` treats `tests/conftest.py` from different example directories as the same module path. The fix is to switch to `importmode = "importlib"` which uses unique module names based on file paths.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pytest configuration to discover and run all non-AWS tests</name>
  <files>pyproject.toml</files>
  <action>
Update the `[tool.pytest.ini_options]` section in pyproject.toml:

1. Change `testpaths` to include both `tests` and all five example test directories:
   ```
   testpaths = [
       "tests",
       "examples/order-processing/tests",
       "examples/data-pipeline/tests",
       "examples/intrinsic-showcase/tests",
       "examples/approval-workflow/tests",
       "examples/retry-and-recovery/tests",
   ]
   ```

2. Add `importmode = "importlib"` to fix the module naming collision. This makes pytest use Python's importlib to assign unique module names based on file paths, preventing the `ImportPathMismatchError` when multiple example directories have identically-named conftest.py files.

3. Keep existing `pythonpath = ["src"]` and markers unchanged.

After editing, verify:
- `pytest --collect-only -q` discovers tests from both tests/ and examples/
- `pytest -m "not integration" -q` runs all non-AWS tests with zero failures
- The total should be 592 + 152 = 744 tests passed (13 deselected)
  </action>
  <verify>
    <automated>.venv/bin/python -m pytest -m "not integration" -q 2>&1 | tail -3</automated>
  </verify>
  <done>
- `pytest -m "not integration"` from project root runs exactly 744 tests with 0 failures
- All 13 integration tests are deselected
- No ImportPathMismatchError or collection errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CI workflow to run the full non-AWS test suite</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Update the test job's "Run tests" step in `.github/workflows/ci.yml`:

The current step is:
```yaml
      - name: Run tests (excluding integration)
        run: pytest -m "not integration" -v
```

This already works correctly because pytest reads testpaths from pyproject.toml. Since Task 1 updated pyproject.toml to include example test directories, CI will automatically discover them.

However, verify the step doesn't need changes. If `pytest -m "not integration" -v` already picks up the new testpaths from pyproject.toml (which it should), no CI file changes are needed.

If for any reason the examples tests need additional path setup in CI (e.g., the mock_sdk import path), ensure that `pythonpath` in pyproject.toml covers it. The current conftest.py files in each example add `project_root / "tests"` to sys.path for mock_sdk access, and `project_root / "src"` for rsf imports. With `pythonpath = ["src"]` in pyproject.toml and `importmode = "importlib"`, this should work. But if mock_sdk imports fail, add `"tests"` to the `pythonpath` list in pyproject.toml.

Validate by running the exact CI command locally:
```bash
.venv/bin/python -m pytest -m "not integration" -v 2>&1 | tail -20
```
  </action>
  <verify>
    <automated>.venv/bin/python -m pytest -m "not integration" -v 2>&1 | tail -5</automated>
  </verify>
  <done>
- The exact command from CI (`pytest -m "not integration" -v`) runs all 744 non-AWS tests
- No collection errors, no import failures
- CI workflow file is correct (may or may not need changes depending on Task 1 results)
  </done>
</task>

</tasks>

<verification>
1. `pytest --collect-only -q 2>&1 | grep "collected"` shows 757 tests collected (744 non-integration + 13 integration)
2. `pytest -m "not integration" -q` runs 744 tests, 0 failures, 13 deselected
3. `pytest -m "integration" --collect-only -q` still shows 13 integration tests
4. `ruff check .` still passes with zero violations (no ruff regressions)
5. CI workflow correctly runs the full non-AWS test suite
</verification>

<success_criteria>
- A single `pytest -m "not integration"` invocation from the project root runs ALL non-AWS tests (both tests/ and examples/*/tests/) with zero failures
- The 13 integration tests remain correctly excluded from the default run
- CI is configured to run the same comprehensive test suite
- No ruff violations introduced
</success_criteria>

<output>
After completion, create `.planning/phases/35-run-all-tests-that-do-not-require-aws-access-resources/35-01-SUMMARY.md`
</output>
