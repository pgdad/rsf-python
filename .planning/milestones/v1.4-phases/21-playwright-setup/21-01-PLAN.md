---
phase: 21-playwright-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ui/package.json
  - ui/scripts/smoke-test.ts
  - ui/tsconfig.scripts.json
autonomous: true
requirements:
  - CAPT-01

must_haves:
  truths:
    - "Running npm install in ui/ installs Playwright and its chromium browser"
    - "A developer can run a minimal Playwright script that opens a browser and navigates to a URL without errors"
    - "Playwright is listed as a devDependency in ui/package.json with a pinned version"
  artifacts:
    - path: "ui/package.json"
      provides: "Playwright devDependency entry and smoke-test npm script"
      contains: "@playwright/test"
    - path: "ui/scripts/smoke-test.ts"
      provides: "Minimal Playwright script that launches Chromium and navigates to a URL"
      min_lines: 20
  key_links:
    - from: "ui/package.json"
      to: "ui/scripts/smoke-test.ts"
      via: "npm run smoke-test script"
      pattern: "smoke-test"
    - from: "ui/scripts/smoke-test.ts"
      to: "chromium browser"
      via: "playwright chromium.launch()"
      pattern: "chromium\\.launch"
---

<objective>
Install Playwright as a pinned devDependency in the ui/ package and verify browser automation works with a minimal smoke test script.

Purpose: Phase 23 screenshot scripts need a working Playwright foundation. This phase installs Playwright, ensures its Chromium browser binary is downloaded on npm install, and proves the setup works with a runnable smoke test.

Output:
- ui/package.json updated with @playwright/test 1.58.2 pinned devDependency and smoke-test script
- ui/scripts/smoke-test.ts — minimal script that launches Chromium, navigates to https://example.com, asserts page title contains "Example", then closes
- ui/tsconfig.scripts.json — TypeScript config for scripts/ directory (Node target, not bundler mode)
</objective>

<execution_context>
@/home/esa/.claude/get-shit-done/workflows/execute-plan.md
@/home/esa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@ui/package.json
@ui/tsconfig.json
@ui/tsconfig.app.json
@ui/tsconfig.node.json
@ui/vite.config.ts
</context>

<interfaces>
<!-- Key facts about the existing ui/ setup. Executor needs these to avoid conflicts. -->

Existing tsconfig structure:
- tsconfig.json: references tsconfig.app.json (includes src/) and tsconfig.node.json (includes vite.config.ts)
- tsconfig.app.json: target ES2022, moduleResolution "bundler", noEmit true, jsx react-jsx, strict
- tsconfig.node.json: target ES2023, moduleResolution "bundler", types ["node"], includes vite.config.ts only

Existing test setup (Vitest + jsdom):
- vitest.config.ts: separate config, environment jsdom, setupFiles src/test/setup.ts
- Scripts in ui/ use "type": "module" — ESM by default

Current devDependencies (abridged):
- typescript ~5.9.3
- vitest ^4.0.18
- @testing-library/react ^16.3.2
- jsdom ^28.1.0
- @types/node ^24.10.1

No existing scripts/ directory in ui/.
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add Playwright devDependency and install browsers</name>
  <files>ui/package.json</files>
  <action>
    In ui/package.json, make two changes:

    1. Add to devDependencies (pinned, no caret):
       "@playwright/test": "1.58.2"

    2. Add to scripts:
       "smoke-test": "node --import tsx/esm scripts/smoke-test.ts"

    Note: The scripts/ directory runs as plain Node (not Vite-bundled), so we need a TypeScript loader. Add tsx as a devDependency too:
       "tsx": "4.19.4"

    After editing package.json, run from the ui/ directory:
       npm install

    Then install the Playwright Chromium browser binary:
       cd ui && npx playwright install chromium

    This must complete without errors. The chromium binary will be cached in ~/.cache/ms-playwright/.

    Verify package-lock.json now contains @playwright/test and tsx entries.
  </action>
  <verify>
    Run from /home/esa/git/rsf-python/ui/:
      node -e "const p = require('./node_modules/@playwright/test/package.json'); console.log(p.version)"
    Expected: 1.58.2

    Run:
      ls ~/.cache/ms-playwright/chromium-* 2>/dev/null | head -3
    Expected: at least one directory listed (confirms browser binary downloaded)
  </verify>
  <done>
    @playwright/test 1.58.2 appears in ui/package.json devDependencies (pinned, no caret).
    tsx 4.19.4 appears in ui/package.json devDependencies.
    smoke-test script entry exists in ui/package.json scripts.
    npm install completes without errors.
    Chromium browser binary is present in ~/.cache/ms-playwright/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create smoke test script and TypeScript config for scripts/</name>
  <files>
    ui/scripts/smoke-test.ts
    ui/tsconfig.scripts.json
  </files>
  <action>
    Create ui/tsconfig.scripts.json for scripts/ TypeScript compilation. Scripts run in Node (not Vite bundler), must NOT use "bundler" moduleResolution (it requires bundler, not Node), and must NOT use "noEmit: true" since tsx executes directly. Use CommonJS-compatible resolution:

    ```json
    {
      "compilerOptions": {
        "target": "ES2022",
        "lib": ["ES2022"],
        "module": "ESNext",
        "moduleResolution": "node",
        "types": ["node"],
        "skipLibCheck": true,
        "strict": true,
        "noUnusedLocals": true,
        "noUnusedParameters": true,
        "esModuleInterop": true
      },
      "include": ["scripts"]
    }
    ```

    Create ui/scripts/smoke-test.ts. This is a standalone script (not a test file, no describe/it blocks). It uses Playwright's raw API to launch a browser, navigate, assert, and close. Keep it simple — purpose is to prove browser automation works:

    ```typescript
    import { chromium } from '@playwright/test';

    async function main() {
      console.log('Launching Chromium...');
      const browser = await chromium.launch({ headless: true });
      const page = await browser.newPage();

      console.log('Navigating to https://example.com...');
      await page.goto('https://example.com');

      const title = await page.title();
      console.log(`Page title: ${title}`);

      if (!title.toLowerCase().includes('example')) {
        throw new Error(`Unexpected title: "${title}"`);
      }

      console.log('Title assertion passed.');
      await browser.close();
      console.log('Browser closed. Playwright smoke test PASSED.');
    }

    main().catch((err) => {
      console.error('Smoke test FAILED:', err);
      process.exit(1);
    });
    ```

    After creating both files, run the smoke test to confirm it works:
      cd /home/esa/git/rsf-python/ui && npm run smoke-test

    Expected output includes:
      - "Launching Chromium..."
      - "Navigating to https://example.com..."
      - "Page title: Example Domain"
      - "Playwright smoke test PASSED."

    If npm run smoke-test fails due to tsx not found, verify tsx was installed in Task 1. If there are import resolution errors, check that tsconfig.scripts.json uses moduleResolution "node" not "bundler".
  </action>
  <verify>
    <automated>cd /home/esa/git/rsf-python/ui && npm run smoke-test 2>&1 | tail -5</automated>
  </verify>
  <done>
    ui/scripts/smoke-test.ts exists.
    ui/tsconfig.scripts.json exists with scripts/ include and node moduleResolution.
    npm run smoke-test exits 0 and prints "Playwright smoke test PASSED."
    No manual browser interaction required.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the three success criteria from the roadmap:

1. npm install installs Playwright + Chromium:
   cd /home/esa/git/rsf-python/ui && npm install && npx playwright install chromium --dry-run
   (dry-run should report browser already installed)

2. Smoke test script runs without errors:
   cd /home/esa/git/rsf-python/ui && npm run smoke-test
   Exit code 0, "Playwright smoke test PASSED." in output.

3. Pinned devDependency in package.json:
   node -e "const p = require('./ui/package.json'); console.log(p.devDependencies['@playwright/test'])"
   Output: 1.58.2 (no caret, pinned)
</verification>

<success_criteria>
- "@playwright/test": "1.58.2" appears in ui/package.json devDependencies (no leading ^ or ~)
- "smoke-test" script entry exists in ui/package.json scripts
- ui/scripts/smoke-test.ts exists and is runnable via `npm run smoke-test`
- `npm run smoke-test` exits with code 0 and prints "Playwright smoke test PASSED."
- Chromium binary present in ~/.cache/ms-playwright/ after npm install + playwright install chromium
- Existing Vitest tests still pass: `cd ui && npm test` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/21-playwright-setup/21-01-SUMMARY.md` with:
- What was installed (Playwright version, tsx version)
- Files created/modified
- How to run the smoke test
- Confirmation that existing Vitest tests were unaffected
</output>
