---
phase: 26-ci-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/release.yml
autonomous: false
requirements: [CICD-01, CICD-02, CICD-03, CICD-04]
user_setup:
  - service: pypi
    why: "OIDC trusted publisher must be configured on PyPI before first tag push"
    dashboard_config:
      - task: "Create pending trusted publisher"
        location: "https://pypi.org/manage/account/publishing/"
        fields:
          - "PyPI Project Name: rsf"
          - "Owner: pgdad"
          - "Repository name: rsf-python"
          - "Workflow filename: release.yml"
          - "Environment name: pypi"

must_haves:
  truths:
    - "A pull request to main triggers lint and test checks visible as PR status"
    - "A push to main triggers lint and test checks"
    - "Pushing a v* tag triggers a build-and-publish workflow"
    - "The release build compiles React UIs before building the Python wheel"
    - "PyPI publishing uses OIDC trusted publisher with no stored API tokens"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "PR and main-branch lint + test workflow"
      contains: "on:\\n  pull_request:"
    - path: ".github/workflows/release.yml"
      provides: "Tag-triggered build + PyPI publish workflow"
      contains: "pypa/gh-action-pypi-publish"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "pyproject.toml"
      via: "python -m build uses hatchling+hatch-vcs from pyproject.toml"
      pattern: "python -m build"
    - from: ".github/workflows/release.yml"
      to: "ui/package.json"
      via: "npm ci && npm run build compiles React UIs before wheel build"
      pattern: "npm run build"
    - from: ".github/workflows/release.yml"
      to: "PyPI OIDC"
      via: "id-token: write permission on publish job enables trusted publisher"
      pattern: "id-token: write"
    - from: ".github/workflows/ci.yml"
      to: "tests/"
      via: "pytest -m 'not integration' runs unit tests excluding AWS integration"
      pattern: "pytest -m .not integration."
---

<objective>
Create GitHub Actions CI/CD workflows for automated testing on pull requests and automated PyPI publishing on git tag pushes.

Purpose: Automate quality gates (lint + test on PRs) and release publishing (wheel build + PyPI upload on v* tags) so that contributors get immediate feedback and maintainers can release by simply pushing a tag.

Output: Two workflow files (`.github/workflows/ci.yml` and `.github/workflows/release.yml`) that provide full CI/CD automation with OIDC-based PyPI authentication.
</objective>

<execution_context>
@/home/esa/.claude/get-shit-done/workflows/execute-plan.md
@/home/esa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-ci-cd-pipeline/26-RESEARCH.md

@pyproject.toml
@ui/package.json

<interfaces>
<!-- From pyproject.toml — build system and test configuration -->
Build system: hatchling + hatch-vcs (git-tag versioning)
Version source: [tool.hatch.version] source = "vcs"
Wheel packages: ["src/rsf"]
Test paths: ["tests"]
Python path: ["src"]
Integration marker: "integration: AWS integration tests (require credentials and terraform)"
Dev dependencies: pytest>=7.0, pytest-asyncio>=0.21, httpx>=0.24
Python requirement: >=3.12

<!-- From ui/package.json — React build -->
React UI lives in ui/ directory
Build command: npm run build (outputs to src/rsf/editor/static/)
Lock file: ui/package-lock.json (required for npm ci)

<!-- Git remote -->
Owner: pgdad
Repository: rsf-python
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CI workflow for PR lint and test checks</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with two jobs:

**Job 1: `lint`**
- runs-on: ubuntu-latest
- Steps:
  1. `actions/checkout@v6`
  2. `astral-sh/ruff-action@v3` (default: runs `ruff check`)
  3. `astral-sh/ruff-action@v3` with `args: "format --check"` (checks formatting)

**Job 2: `test`**
- runs-on: ubuntu-latest
- strategy.matrix.python-version: ['3.12', '3.13'] with fail-fast: false
- Steps:
  1. `actions/checkout@v6`
  2. `actions/setup-python@v6` with python-version from matrix and cache: 'pip'
  3. `pip install -e ".[dev]"` to install the package with dev dependencies
  4. `pytest -m "not integration" -v` to run all tests EXCEPT integration tests (which require AWS credentials)

Trigger on:
```yaml
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
```

Workflow name: `CI`

Do NOT set any special permissions at workflow or job level — default read permissions are sufficient for CI.
Do NOT include `ruff` in pyproject.toml dependencies — the `astral-sh/ruff-action@v3` handles installation automatically.
  </action>
  <verify>
  <automated>cat .github/workflows/ci.yml && python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" 2>/dev/null || python3 -c "import json; print('YAML validation requires pyyaml - checking structure manually')" && grep -q 'pull_request' .github/workflows/ci.yml && grep -q 'ruff-action' .github/workflows/ci.yml && grep -q 'pytest.*not integration' .github/workflows/ci.yml && echo 'PASS: ci.yml structure verified'</automated>
  </verify>
  <done>
  - ci.yml exists at .github/workflows/ci.yml
  - Triggers on pull_request and push to main
  - Lint job uses astral-sh/ruff-action for both check and format
  - Test job runs pytest on Python 3.12 and 3.13 matrix, excluding integration tests
  - Valid YAML syntax
  </done>
</task>

<task type="auto">
  <name>Task 2: Create release workflow for tag-triggered PyPI publishing</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` with two jobs following the PyPA-recommended pattern:

**Job 1: `build`**
- runs-on: ubuntu-latest
- Steps:
  1. `actions/checkout@v6` with `fetch-depth: 0` (CRITICAL: hatch-vcs needs full git history to derive version from tags)
  2. `actions/setup-node@v6` with node-version: '22', cache: 'npm', cache-dependency-path: 'ui/package-lock.json'
  3. Build React UI: `npm ci && npm run build` with `working-directory: ui` (CICD-03: React UIs compiled as part of build)
  4. `actions/setup-python@v6` with python-version: '3.12'
  5. Install build tools: `pip install build hatch-vcs`
  6. Build wheel and sdist: `python -m build`
  7. `actions/upload-artifact@v4` with name: 'python-package-distributions', path: 'dist/'

**Job 2: `publish-to-pypi`**
- needs: build
- runs-on: ubuntu-latest
- environment: name: pypi, url: https://pypi.org/p/rsf
- permissions: id-token: write (CICD-04: OIDC trusted publisher, scoped to this job ONLY)
- Steps:
  1. `actions/download-artifact@v4` with name: 'python-package-distributions', path: 'dist/'
  2. `pypa/gh-action-pypi-publish@release/v1` (no configuration needed — OIDC handles auth)

Trigger on:
```yaml
on:
  push:
    tags:
      - 'v*'
```

Workflow name: `Release`

CRITICAL constraints:
- Do NOT set `id-token: write` at workflow level — only on the publish job (principle of least privilege)
- Do NOT use `npm install` — use `npm ci` (deterministic, uses lock file)
- Do NOT use shallow checkout — `fetch-depth: 0` is mandatory for hatch-vcs
- The React build MUST run before `python -m build` in the SAME job so static assets exist on disk when hatchling packages them
  </action>
  <verify>
  <automated>cat .github/workflows/release.yml && grep -q "fetch-depth: 0" .github/workflows/release.yml && grep -q "npm run build" .github/workflows/release.yml && grep -q "python -m build" .github/workflows/release.yml && grep -q "id-token: write" .github/workflows/release.yml && grep -q "pypa/gh-action-pypi-publish" .github/workflows/release.yml && grep -q "environment" .github/workflows/release.yml && echo 'PASS: release.yml structure verified'</automated>
  </verify>
  <done>
  - release.yml exists at .github/workflows/release.yml
  - Triggers on v* tag push only
  - Build job: full checkout (fetch-depth: 0), React UI compile (npm ci + npm run build in ui/), Python wheel build (python -m build), artifact upload
  - Publish job: downloads artifact, uses pypa/gh-action-pypi-publish with OIDC (id-token: write on job level only)
  - Uses GitHub environment named "pypi"
  - Valid YAML syntax
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure PyPI trusted publisher</name>
  <what-built>Two GitHub Actions workflow files are in the repository. The release workflow uses OIDC trusted publishing which requires a one-time manual configuration on PyPI before the first v* tag push.</what-built>
  <how-to-verify>
    Before pushing the first release tag, configure a pending trusted publisher on PyPI:

    1. Go to https://pypi.org/manage/account/publishing/
    2. Under "Add a new pending publisher", fill in:
       - PyPI Project Name: `rsf`
       - Owner: `pgdad`
       - Repository name: `rsf-python`
       - Workflow filename: `release.yml`
       - Environment name: `pypi`
    3. Click "Add"

    NOTE: If the project name `rsf` is already taken on PyPI by another user, you will need to choose a different name and update `pyproject.toml` accordingly.

    This step is only needed once. After configuration, any v* tag push will automatically publish via OIDC without stored API tokens.
  </how-to-verify>
  <resume-signal>Type "configured" after setting up the trusted publisher on PyPI, or "skip" to defer this to later</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `.github/workflows/ci.yml` exists with lint + test jobs triggered on PR and push to main
2. `.github/workflows/release.yml` exists with build + publish jobs triggered on v* tag push
3. Both files are valid YAML
4. CI workflow: uses ruff-action for lint, pytest with integration exclusion for tests, Python 3.12+3.13 matrix
5. Release workflow: full checkout for hatch-vcs, React UI build before wheel build, OIDC publish with id-token scoped to publish job
6. No API tokens or secrets referenced anywhere in the workflows
</verification>

<success_criteria>
- Two workflow files committed to `.github/workflows/`
- CI workflow would run lint and tests on any PR to main (verifiable by pushing a branch and opening a PR)
- Release workflow would build React UI + wheel and publish to PyPI on any v* tag push (verifiable after PyPI trusted publisher is configured)
- OIDC trusted publishing — zero stored secrets in GitHub repository settings
</success_criteria>

<output>
After completion, create `.planning/phases/26-ci-cd-pipeline/26-01-SUMMARY.md`
</output>
