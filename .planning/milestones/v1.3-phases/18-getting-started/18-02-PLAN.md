---
phase: 18-getting-started
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tutorials/02-workflow-validation.md
autonomous: true
requirements:
  - SETUP-02

must_haves:
  truths:
    - "User can run rsf validate on a valid workflow and see the success message"
    - "User can intentionally introduce each of the 3 error types (YAML syntax, Pydantic structural, semantic) and interpret the corresponding error messages"
    - "User can use the field-path in error messages to locate and fix problems in workflow.yaml"
  artifacts:
    - path: "tutorials/02-workflow-validation.md"
      provides: "Step-by-step rsf validate tutorial with 3-stage error examples and fix instructions"
      min_lines: 200
  key_links:
    - from: "tutorials/02-workflow-validation.md"
      to: "src/rsf/cli/validate_cmd.py"
      via: "Documents the exact 3-stage validation pipeline"
      pattern: "rsf validate"
---

<objective>
Create a comprehensive step-by-step tutorial for `rsf validate` that teaches users to validate workflow YAML and interpret all three stages of validation errors.

Purpose: Users need to understand the validation pipeline so they can confidently author and debug workflow YAML files. The tutorial teaches error interpretation through intentional error introduction — a learn-by-breaking approach.
Output: `tutorials/02-workflow-validation.md` — a complete tutorial document.
</objective>

<execution_context>
@/home/esa/.claude/get-shit-done/workflows/execute-plan.md
@/home/esa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/rsf/cli/validate_cmd.py
@src/rsf/dsl/validator.py
@src/rsf/dsl/parser.py
@src/rsf/cli/templates/workflow.yaml

<interfaces>
<!-- The rsf validate command behavior (from src/rsf/cli/validate_cmd.py):

  Takes one argument: workflow path (defaults to "workflow.yaml")

  3-stage validation pipeline:

  Stage 1 — File existence + YAML parse:
    - Checks file exists, prints "Error: File not found: {path}" if missing
    - Parses YAML with yaml.safe_load via dsl_parser.load_yaml()
    - On YAML syntax error: prints "Error: Invalid YAML in {path}: {exc}"
    - On non-dict result: prints "Error: Workflow file must be a YAML mapping, got: {type}"

  Stage 2 — Pydantic structural validation:
    - Calls dsl_parser.parse_definition(data) which runs StateMachineDefinition.model_validate()
    - On ValidationError: prints "Validation errors in {path}:" then for each error:
      "  {field_path}: {msg}" where field_path = ".".join(error["loc"])

  Stage 3 — Semantic validation:
    - Calls validate_definition(definition) which runs BFS-based cross-state checks:
      a. All Next/Default/Catch.Next references resolve to existing states
      b. All states reachable from StartAt (BFS)
      c. At least one terminal state exists (Succeed, Fail, or End: true)
      d. States.ALL must be last in Retry/Catch arrays
      e. Recursive validation for Parallel branches and Map ItemProcessor
    - On errors: prints "Semantic errors in {path}:" then for each error:
      "  {path}: {message}" (path is field path like "States.MyState.Next")

  On success: prints "Valid: {path}"
-->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write the rsf validate tutorial</name>
  <files>tutorials/02-workflow-validation.md</files>
  <action>
Create the file `tutorials/02-workflow-validation.md` with the following structure and content:

**Title:** "Tutorial 2: Workflow Validation with `rsf validate`"

**Sections to include (in order):**

1. **What You'll Learn** — Brief overview: validate workflow YAML, understand the 3-stage validation pipeline, intentionally break and fix a workflow to learn error interpretation.

2. **Prerequisites** — Completed Tutorial 1 (have a project created with `rsf init`). Should have `my-workflow/` directory with `workflow.yaml`.

3. **The 3-Stage Validation Pipeline** — Overview diagram/explanation of the three stages:
   - Stage 1: YAML Syntax — Is it valid YAML?
   - Stage 2: Structural Validation — Does it match the RSF schema? (Pydantic)
   - Stage 3: Semantic Validation — Are cross-state references consistent? (BFS traversal)

   Explain that validation stops at the first failing stage — you fix Stage 1 errors before seeing Stage 2 errors.

4. **Step 1: Validate the Starter Workflow** — Show `cd my-workflow && rsf validate`. Expected output:
   ```
   Valid: workflow.yaml
   ```
   Explain this means all 3 stages passed. The starter workflow is intentionally valid.

5. **Step 2: Break It — YAML Syntax Error (Stage 1)** —
   - Tell user to edit `workflow.yaml` and introduce a YAML syntax error. Provide the exact broken content — use bad indentation or a missing colon. For example, change `StartAt: HelloWorld` to `StartAt HelloWorld` (missing colon).
   - Show the exact command: `rsf validate`
   - Show the expected error output: `Error: Invalid YAML in workflow.yaml: ...` with a realistic YAML error message.
   - **How to read this error:** Explain that Stage 1 errors mean the file isn't valid YAML at all. The fix is always a YAML syntax issue (indentation, colons, quotes).
   - **Fix it:** Show the corrected line and tell user to restore it.

6. **Step 3: Break It — Structural Error (Stage 2)** —
   - Tell user to edit `workflow.yaml` and introduce a structural error. Provide the exact broken content — use an invalid state type. For example, change `Type: Pass` to `Type: Invalid`.
   - Show the exact command: `rsf validate`
   - Show the expected error output: `Validation errors in workflow.yaml:` with field-path errors like `states.HelloWorld.Type: Input should be 'Task', 'Pass', 'Choice', ...`
   - **How to read this error:** Explain the field-path format (`states.HelloWorld.Type`) tells you exactly where to look. The dot-separated path maps to the YAML nesting. Explain this is the Pydantic model validation layer checking each field against the RSF schema.
   - **Fix it:** Show the corrected line and tell user to restore it.

7. **Step 4: Break It — Semantic Error (Stage 3)** —
   - Tell user to edit `workflow.yaml` and introduce a semantic error. Provide the exact broken content — change `Next: Done` to `Next: NonExistent` (reference to a state that doesn't exist).
   - Show the exact command: `rsf validate`
   - Show the expected error output: `Semantic errors in workflow.yaml:` with errors like `States.HelloWorld.Next: Next 'NonExistent' does not reference an existing state`
   - **How to read this error:** Explain the field-path format for semantic errors (`States.HelloWorld.Next`). Explain that semantic validation catches logical consistency issues that can't be detected by schema alone — dangling references, unreachable states, missing terminal states.
   - **Fix it:** Show the corrected line and tell user to restore it.

8. **Step 5: Validate a Custom Workflow** — Provide a slightly more complex workflow for the user to try (3-4 states using Task and Choice). Include the full YAML. Have the user save it as `workflow.yaml`, run `rsf validate`, and confirm it passes. This shows validation on a real-ish workflow, not just the starter.

9. **Error Reference** — A quick-reference table of common error patterns:
   | Error Stage | Example Message | What It Means | How to Fix |
   |---|---|---|---|
   | Stage 1 (YAML) | "Invalid YAML in workflow.yaml" | YAML syntax broken | Check indentation, colons, quotes |
   | Stage 2 (Structural) | "states.X.Type: Input should be..." | Field doesn't match RSF schema | Check field name and allowed values |
   | Stage 3 (Semantic) | "States.X.Next: Next 'Y' does not reference..." | Cross-state reference broken | Check state names match exactly |
   | Stage 3 (Semantic) | "State 'X' is not reachable from StartAt" | Orphaned state | Add a transition to the state or remove it |
   | Stage 3 (Semantic) | "State machine must have at least one terminal state" | No Succeed/Fail/End state | Add a Succeed or Fail state |

10. **What's Next** — Point to Tutorial 3 (rsf generate) for generating orchestrator code from validated workflows. Reinforce: always validate before generating.

**Style guidelines:**
- Use clear, direct language. No marketing fluff.
- Every command should be in a fenced code block with `bash` syntax highlighting.
- Every YAML snippet should be in a fenced code block with `yaml` syntax highlighting.
- When showing a "broken" version, show the FULL workflow.yaml content so users can copy-paste it exactly (don't show just the changed line — show the whole file). This prevents user confusion about what the file should look like.
- Use blockquotes (> ) for important notes or tips.
- Use bold for **Stage 1**, **Stage 2**, **Stage 3** labels consistently throughout.
- Keep explanations concise but thorough for error interpretation — users need to learn the pattern, not just the fix.
- Do NOT use emojis.
  </action>
  <verify>
    <automated>test -f tutorials/02-workflow-validation.md && wc -l tutorials/02-workflow-validation.md | awk '{if ($1 >= 200) print "PASS: "$1" lines"; else print "FAIL: only "$1" lines"}'</automated>
  </verify>
  <done>
    - tutorials/02-workflow-validation.md exists with 200+ lines
    - Tutorial covers: prerequisites, 3-stage pipeline overview, validating the starter workflow, breaking with YAML error (Stage 1), breaking with structural error (Stage 2), breaking with semantic error (Stage 3), validating a custom workflow, error reference table
    - Each "break it" section shows the FULL broken workflow.yaml content, the rsf validate command, the expected error output, how to read the error, and how to fix it
    - Error messages shown match actual output format from validate_cmd.py (field-path: message)
    - Commands are concrete and copy-pasteable
  </done>
</task>

</tasks>

<verification>
1. `tutorials/02-workflow-validation.md` exists and has 200+ lines
2. Tutorial documents all 3 validation stages with concrete error examples
3. Each error example shows: full broken file, command to run, expected error output, explanation, and fix
4. Error output format matches actual `validate_cmd.py` behavior (field-path-specific messages)
5. Custom workflow example in Step 5 would actually pass `rsf validate` (correct RSF YAML)
6. Error reference table covers all 5 common error patterns from the validator
</verification>

<success_criteria>
A user reading this tutorial can: run `rsf validate` on a valid workflow, intentionally introduce each of the 3 error types, interpret the field-path-specific error messages to locate the problem, fix the error, and re-validate successfully.
</success_criteria>

<output>
After completion, create `.planning/phases/18-getting-started/18-02-SUMMARY.md`
</output>
