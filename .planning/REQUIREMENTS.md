# Requirements: RSF — Replacement for Step Functions

**Defined:** 2026-02-24
**Core Value:** Users can define, visualize, generate, deploy, and debug state machine workflows on Lambda Durable Functions with full AWS Step Functions feature parity — without writing state management or orchestration code by hand.

## v1 Requirements

Requirements for initial release. Each maps to roadmap phases.

### DSL Models

- [ ] **DSL-01**: User can define workflows in YAML/JSON with `rsf_version`, `StartAt`, `States`, and optional `Comment`, `Version`, `TimeoutSeconds`, `QueryLanguage` fields
- [ ] **DSL-02**: User can define Task states with I/O processing, timeout, heartbeat, Retry policies (exponential backoff, jitter), and Catch handlers
- [ ] **DSL-03**: User can define Pass states with optional `Result` injection and `ResultPath`
- [ ] **DSL-04**: User can define Choice states with 39 comparison operators (equality, ordering, pattern, type checking), boolean logic (And/Or/Not), and Default fallback
- [ ] **DSL-05**: User can define Wait states with exactly one of Seconds/Timestamp/SecondsPath/TimestampPath
- [ ] **DSL-06**: User can define Succeed and Fail terminal states (Fail with Error/Cause and Path variants, no I/O fields)
- [ ] **DSL-07**: User can define Parallel states with concurrent branches (sub-state machines), Retry, and Catch
- [ ] **DSL-08**: User can define Map states with ItemProcessor (INLINE/DISTRIBUTED), ItemsPath, MaxConcurrency, ItemSelector, Retry, and Catch
- [ ] **DSL-09**: All models use Pydantic v2 with `extra=forbid`, PascalCase aliases, `populate_by_name=True`, and discriminated union for State types
- [ ] **DSL-10**: Semantic validator performs BFS cross-state validation: reference resolution, reachability, terminal state existence, States.ALL ordering, recursive branch validation

### I/O Processing

- [ ] **IO-01**: User's workflows process data through 5-stage JSONPath pipeline: InputPath → Parameters → ResultSelector → ResultPath → OutputPath
- [ ] **IO-02**: ResultPath merges into raw input (not effective input) with deep-copy to prevent mutation
- [ ] **IO-03**: JSONPath evaluator supports ASL subset: root ($), dot/bracket notation, array indexing, variable references ($varName)
- [ ] **IO-04**: Payload templates resolve keys ending with `.$` (JSONPath refs, context refs, intrinsic function calls)
- [ ] **IO-05**: ResultPath handles `$` (replace all), `$.field` (deep merge), and `null` (discard result)

### Intrinsic Functions

- [ ] **FUNC-01**: 18 intrinsic functions registered via `@intrinsic` decorator: Format, StringToJson, JsonToString, Array, ArrayPartition, ArrayContains, ArrayRange, ArrayGetItem, ArrayLength, ArrayUnique, Base64Encode, Base64Decode, Hash, MathRandom, MathAdd, StringSplit, UUID
- [ ] **FUNC-02**: Recursive descent parser supporting nested calls, string escaping, path/context references, JSON literals, max nesting depth 10

### Context Object

- [ ] **CTX-01**: ASL Context Object model with Execution (Id, Input, Name, RoleArn, StartTime, RedriveCount), State (EnteredTime, Name, RetryCount), StateMachine (Id, Name), Task (Token), Map (Item with Index/Key/Value/Source)

### Variables

- [ ] **VAR-01**: Variable store and resolver supporting `$varName` detection and runtime variable storage with Assign/Output support

### Handler Registry

- [ ] **REG-01**: `@state(name)` decorator registers handler functions; validates non-empty string; raises ValueError on duplicate
- [ ] **REG-02**: `@startup` decorator registers cold-start initialization hooks
- [ ] **REG-03**: `get_handler(name)` retrieves handlers; raises KeyError with registered state list
- [ ] **REG-04**: `discover_handlers(directory)` auto-imports .py files to trigger decorator registration
- [ ] **REG-05**: `clear()` and `clear_startup_hooks()` for test isolation

### Code Generation

- [ ] **GEN-01**: BFS traversal from StartAt maps all 8 state types to SDK primitives (context.step, context.wait, conditional, passthrough, return, raise WorkflowError, context.parallel, context.map)
- [ ] **GEN-02**: Jinja2 template generates orchestrator with while-loop state machine, startup hooks, handler imports, WorkflowError class
- [ ] **GEN-03**: Handler stub template generates `@state` decorated functions with NotImplementedError
- [ ] **GEN-04**: Generation Gap pattern: first-line marker `# DO NOT EDIT - Generated by RSF` determines overwritability; user files never touched
- [ ] **GEN-05**: Custom `topyrepr` Jinja2 filter produces Python literals (True/False/None not true/false/null)
- [ ] **GEN-06**: Generated orchestrator includes DSL file SHA-256 hash and version in header comment

### Terraform Generation

- [ ] **TF-01**: main.tf with Lambda function (durable_config block), archive_file data source, lifecycle ignore
- [ ] **TF-02**: variables.tf with validated inputs (aws_region, name_prefix, workflow_name, timeout, memory_size, execution_timeout, retention_period, etc.)
- [ ] **TF-03**: iam.tf with IAM role and policy (CloudWatch Logs, Lambda self-invoke, durable execution permissions)
- [ ] **TF-04**: outputs.tf with function_arn, function_name, role_arn, log_group_name
- [ ] **TF-05**: cloudwatch.tf with log group and configurable retention
- [ ] **TF-06**: backend.tf for optional S3 remote state
- [ ] **TF-07**: Custom Jinja2 delimiters (`<< >>` variables, `<% %>` blocks, `<# #>` comments) to avoid HCL conflicts
- [ ] **TF-08**: IAM permission derivation returns exactly 3 base statements (CloudWatch, Lambda self-invoke, durable execution)
- [ ] **TF-09**: Generation Gap pattern applied to Terraform files
- [ ] **TF-10**: Name sanitizer converts PascalCase/kebab-case to valid Terraform identifiers

### ASL Importer

- [ ] **IMP-01**: Parse ASL JSON files with error detail reporting
- [ ] **IMP-02**: Convert ASL to RSF format: inject rsf_version, reject Resource field with guidance, strip Fail state I/O fields, rename Iterator → ItemProcessor
- [ ] **IMP-03**: Warn on distributed Map fields (ItemReader, ItemBatcher, ResultWriter)
- [ ] **IMP-04**: Recursive conversion for Parallel branches and Map ItemProcessor sub-machines
- [ ] **IMP-05**: Emit clean YAML output from converted dict
- [ ] **IMP-06**: Generate handler stubs for every Task state found in imported workflow

### CLI

- [ ] **CLI-01**: `rsf init <project-name>` scaffolds project with directory structure, workflow.yaml, pyproject.toml, handler example, test example, .gitignore
- [ ] **CLI-02**: `rsf generate <workflow.yaml>` parses DSL, validates, maps states, renders orchestrator, creates handler stubs (if missing), maintains handlers/__init__.py
- [ ] **CLI-03**: `rsf validate <workflow.yaml>` validates DSL (Pydantic + semantic) without generating code, reports errors with paths
- [ ] **CLI-04**: `rsf deploy [--code-only]` generates Terraform, runs terraform init/apply; --code-only re-packages and updates Lambda code only
- [ ] **CLI-05**: `rsf import <asl.json> [--output workflow.yaml]` imports Step Functions ASL JSON through full pipeline
- [ ] **CLI-06**: `rsf ui [workflow.yaml] [--port 8765]` launches graph editor FastAPI server, serves React SPA, auto-opens browser
- [ ] **CLI-07**: `rsf inspect [--arn <lambda-arn>] [--port 8766]` launches inspector with ARN discovery (terraform output or --arn override)
- [ ] **CLI-08**: Typer-based CLI with --version flag and subcommands

### Graph Editor Backend

- [ ] **GEB-01**: FastAPI serves built React SPA as static files
- [ ] **GEB-02**: REST endpoint `GET /api/schema` returns JSON Schema for DSL
- [ ] **GEB-03**: WebSocket endpoint `/ws` handles parse, validate, load_file, save_file, get_schema messages
- [ ] **GEB-04**: Server sends parsed (AST + errors), validated, file_loaded, file_saved, schema, error responses
- [ ] **GEB-05**: Auto-load workflow file on WebSocket connect if configured

### Graph Editor UI

- [ ] **GEU-01**: Zustand flow store with nodes, edges, yamlContent, validationErrors, selectedNodeId, syncSource, needsLayout, lastAst
- [ ] **GEU-02**: YAML → Graph sync: Monaco edit → debounce 300ms → WebSocket parse → astToFlowElements → position preservation → syncSource prevents loopback
- [ ] **GEU-03**: Graph → YAML sync: graph change → mergeGraphIntoYaml (clone lastAst, update transitions, preserve complex data) → fallback to buildYamlFromNodes
- [ ] **GEU-04**: syncSource pattern: set before mutation, cleared after queueMicrotask() to prevent infinite loops
- [ ] **GEU-05**: 8 per-state-type React node components (TaskNode with badges, ChoiceNode with rule count, ParallelNode/MapNode as containers, etc.)
- [ ] **GEU-06**: TransitionEdge with solid/dashed styles, Catch labels, Default styling
- [ ] **GEU-07**: ELK.js auto-layout with Sugiyama layered algorithm (top-to-bottom, hierarchical)
- [ ] **GEU-08**: GraphCanvas with drag-drop, minimap, controls, background grid
- [ ] **GEU-09**: MonacoEditor with monaco-yaml schema validation and autocompletion
- [ ] **GEU-10**: Palette with 8 state type buttons for drag-to-create
- [ ] **GEU-11**: Inspector panel for selected node property editing
- [ ] **GEU-12**: ValidationOverlay showing error badges on canvas nodes

### Inspector Backend

- [ ] **INB-01**: `GET /api/inspect/executions` lists durable executions with status filter and max_items
- [ ] **INB-02**: `GET /api/inspect/execution/{arn}` returns execution detail with history
- [ ] **INB-03**: `GET /api/inspect/execution/{arn}/history` returns history events only
- [ ] **INB-04**: `GET /api/inspect/execution/{arn}/stream` SSE stream with named events (execution_info, history, history_update)
- [ ] **INB-05**: SSE stream lifecycle: connect → initial events → poll 5s → close on terminal status
- [ ] **INB-06**: Async boto3 Lambda client with token bucket rate limiter (12 req/s ceiling)
- [ ] **INB-07**: Timestamp normalization (seconds → UTC datetime) and pagination for execution list

### Inspector UI

- [ ] **INU-01**: Three-panel layout: execution list (left), graph with overlays + header (center), event timeline + state detail (right)
- [ ] **INU-02**: Zustand inspect store with functionName, executions, selectedExecution, events, nodes/edges, overlays, playbackIndex
- [ ] **INU-03**: Node overlays with status (pending/running/succeeded/failed/caught), timing, input/output/error, retry attempt
- [ ] **INU-04**: Edge overlays with traversed flag and timestamp
- [ ] **INU-05**: Time machine with precomputed TransitionSnapshots for O(1) scrubbing
- [ ] **INU-06**: Structural JSON data diff between state transitions (color-coded, flat path comparison)
- [ ] **INU-07**: Live SSE updates for running executions, auto-close on terminal, pause when tab hidden
- [ ] **INU-08**: ExecutionList with status filter, search, color-coded status icons
- [ ] **INU-09**: ExecutionHeader with name, status, timing, ARN display
- [ ] **INU-10**: EventTimeline with vertical timeline, click to select event
- [ ] **INU-11**: TimelineScrubber slider for time machine playback
- [ ] **INU-12**: StateDetailPanel showing input/output/error for selected node

### Schema

- [ ] **SCH-01**: Generate JSON Schema (Draft 2020-12) from Pydantic v2 models via `model_json_schema()`
- [ ] **SCH-02**: Schema stored at `schema/rsf-dsl.schema.json` and served via `GET /api/schema`

### Testing

- [ ] **TST-01**: Mock durable execution SDK (MockDurableContext) with step, wait, parallel, map implementations
- [ ] **TST-02**: DSL model tests covering every state type, field, validator, and error case
- [ ] **TST-03**: Choice rule tests for all 39 operators, boolean combinations, edge cases
- [ ] **TST-04**: Code generation tests for all 8 state types producing valid Python
- [ ] **TST-05**: Replay safety tests confirming deterministic output (same DSL → same code)
- [ ] **TST-06**: Regeneration safety tests confirming Generation Gap preserves user files
- [ ] **TST-07**: I/O pipeline tests for all 5 stages including edge cases
- [ ] **TST-08**: Intrinsic function tests for all 18 functions with various argument types
- [ ] **TST-09**: Terraform generation tests including HCL output, IAM derivation, variable validation
- [ ] **TST-10**: Importer tests for ASL conversion, Resource rejection, warning generation
- [ ] **TST-11**: Inspector tests for model serialization, API endpoints, SSE streaming
- [ ] **TST-12**: SDK integration tests executing generated code via mock SDK
- [ ] **TST-13**: 22+ valid and 8+ invalid DSL fixture files for conformance testing
- [ ] **TST-14**: React UI tests (vitest) for components and sync logic

### Documentation

- [ ] **DOC-01**: Tutorial: step-by-step from install through deploy + inspect
- [ ] **DOC-02**: Migration guide: importing existing Step Functions workflows
- [ ] **DOC-03**: DSL reference: complete field reference for all state types
- [ ] **DOC-04**: README with project overview, quickstart, architecture
- [ ] **DOC-05**: MkDocs Material theme with admonition, code tabs, superfences

## v2 Requirements

Deferred to future release. Tracked but not in current roadmap.

### Extended Features

- **V2-01**: Go or other language runtime support
- **V2-02**: VS Code extension for DSL editing
- **V2-03**: Direct AWS Console integration
- **V2-04**: Real `BatchResult` handling in mock SDK (currently returns plain lists)

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Multi-language support (Go, etc.) | Python-only implementation per blueprint |
| Team collaboration features | Local-first tool, no multi-user editing needed |
| Hosted web service with auth | Runs on developer's machine only |
| Mobile app | Desktop developer tool |
| Real-time chat/collaboration | Not applicable to dev tooling |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| DSL-01 | Phase 1 | Pending |
| DSL-02 | Phase 1 | Pending |
| DSL-03 | Phase 1 | Pending |
| DSL-04 | Phase 1 | Pending |
| DSL-05 | Phase 1 | Pending |
| DSL-06 | Phase 1 | Pending |
| DSL-07 | Phase 1 | Pending |
| DSL-08 | Phase 1 | Pending |
| DSL-09 | Phase 1 | Pending |
| DSL-10 | Phase 1 | Pending |
| IO-01 | Phase 1 | Pending |
| IO-02 | Phase 1 | Pending |
| IO-03 | Phase 1 | Pending |
| IO-04 | Phase 1 | Pending |
| IO-05 | Phase 1 | Pending |
| FUNC-01 | Phase 1 | Pending |
| FUNC-02 | Phase 1 | Pending |
| CTX-01 | Phase 1 | Pending |
| VAR-01 | Phase 1 | Pending |
| SCH-01 | Phase 1 | Pending |
| SCH-02 | Phase 1 | Pending |
| REG-01 | Phase 2 | Pending |
| REG-02 | Phase 2 | Pending |
| REG-03 | Phase 2 | Pending |
| REG-04 | Phase 2 | Pending |
| REG-05 | Phase 2 | Pending |
| GEN-01 | Phase 2 | Pending |
| GEN-02 | Phase 2 | Pending |
| GEN-03 | Phase 2 | Pending |
| GEN-04 | Phase 2 | Pending |
| GEN-05 | Phase 2 | Pending |
| GEN-06 | Phase 2 | Pending |
| TF-01 | Phase 3 | Pending |
| TF-02 | Phase 3 | Pending |
| TF-03 | Phase 3 | Pending |
| TF-04 | Phase 3 | Pending |
| TF-05 | Phase 3 | Pending |
| TF-06 | Phase 3 | Pending |
| TF-07 | Phase 3 | Pending |
| TF-08 | Phase 3 | Pending |
| TF-09 | Phase 3 | Pending |
| TF-10 | Phase 3 | Pending |
| IMP-01 | Phase 4 | Pending |
| IMP-02 | Phase 4 | Pending |
| IMP-03 | Phase 4 | Pending |
| IMP-04 | Phase 4 | Pending |
| IMP-05 | Phase 4 | Pending |
| IMP-06 | Phase 4 | Pending |
| CLI-01 | Phase 5 | Pending |
| CLI-02 | Phase 5 | Pending |
| CLI-03 | Phase 5 | Pending |
| CLI-04 | Phase 5 | Pending |
| CLI-05 | Phase 5 | Pending |
| CLI-06 | Phase 5 | Pending |
| CLI-07 | Phase 5 | Pending |
| CLI-08 | Phase 5 | Pending |
| GEB-01 | Phase 6 | Pending |
| GEB-02 | Phase 6 | Pending |
| GEB-03 | Phase 6 | Pending |
| GEB-04 | Phase 6 | Pending |
| GEB-05 | Phase 6 | Pending |
| GEU-01 | Phase 7 | Pending |
| GEU-02 | Phase 7 | Pending |
| GEU-03 | Phase 7 | Pending |
| GEU-04 | Phase 7 | Pending |
| GEU-05 | Phase 7 | Pending |
| GEU-06 | Phase 7 | Pending |
| GEU-07 | Phase 7 | Pending |
| GEU-08 | Phase 7 | Pending |
| GEU-09 | Phase 7 | Pending |
| GEU-10 | Phase 7 | Pending |
| GEU-11 | Phase 7 | Pending |
| GEU-12 | Phase 7 | Pending |
| INB-01 | Phase 8 | Pending |
| INB-02 | Phase 8 | Pending |
| INB-03 | Phase 8 | Pending |
| INB-04 | Phase 8 | Pending |
| INB-05 | Phase 8 | Pending |
| INB-06 | Phase 8 | Pending |
| INB-07 | Phase 8 | Pending |
| INU-01 | Phase 9 | Pending |
| INU-02 | Phase 9 | Pending |
| INU-03 | Phase 9 | Pending |
| INU-04 | Phase 9 | Pending |
| INU-05 | Phase 9 | Pending |
| INU-06 | Phase 9 | Pending |
| INU-07 | Phase 9 | Pending |
| INU-08 | Phase 9 | Pending |
| INU-09 | Phase 9 | Pending |
| INU-10 | Phase 9 | Pending |
| INU-11 | Phase 9 | Pending |
| INU-12 | Phase 9 | Pending |
| TST-01 | Phase 10 | Pending |
| TST-02 | Phase 10 | Pending |
| TST-03 | Phase 10 | Pending |
| TST-04 | Phase 10 | Pending |
| TST-05 | Phase 10 | Pending |
| TST-06 | Phase 10 | Pending |
| TST-07 | Phase 10 | Pending |
| TST-08 | Phase 10 | Pending |
| TST-09 | Phase 10 | Pending |
| TST-10 | Phase 10 | Pending |
| TST-11 | Phase 10 | Pending |
| TST-12 | Phase 10 | Pending |
| TST-13 | Phase 10 | Pending |
| TST-14 | Phase 10 | Pending |
| DOC-01 | Phase 11 | Pending |
| DOC-02 | Phase 11 | Pending |
| DOC-03 | Phase 11 | Pending |
| DOC-04 | Phase 11 | Pending |
| DOC-05 | Phase 11 | Pending |

**Coverage:**
- v1 requirements: 111 total (10 DSL + 5 IO + 2 FUNC + 1 CTX + 1 VAR + 5 REG + 6 GEN + 10 TF + 6 IMP + 8 CLI + 5 GEB + 12 GEU + 7 INB + 12 INU + 2 SCH + 14 TST + 5 DOC)
- Mapped to phases: 111
- Unmapped: 0

---
*Requirements defined: 2026-02-24*
*Last updated: 2026-02-25 after roadmap creation*
